<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>360° Memory Room — Mobile-optimized (16:9)</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root{
      --sidebar-w:320px;
      --thumb-w:120px;
      --thumb-h:68px;
      --btn-size:44px;
    }
    html,body{height:100%;margin:0;background:#000;font-family:Inter,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    a-scene, canvas{width:100%;height:100%;display:block}

    /* Layout: sidebar on the right (desktop/tablet) */
    #sidebar{
      position:fixed;
      right:12px;
      top:12px;
      width:var(--sidebar-w);
      max-height:calc(100% - 24px);
      background:rgba(0,0,0,0.55);
      padding:10px;border-radius:10px;
      overflow-y:auto;z-index:9999;transition:transform .22s ease, opacity .2s ease;
      box-shadow:0 8px 24px rgba(0,0,0,0.5);
      -webkit-backdrop-filter: blur(6px);backdrop-filter: blur(6px)
    }
    .vid-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)}
    .vid-thumb{width:var(--thumb-w);height:var(--thumb-h);border-radius:6px;overflow:hidden;position:relative;flex-shrink:0;background:#000;will-change:transform}
    .vid-thumb video{width:100%;height:100%;object-fit:cover;display:block}
    .centerBtn{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:5;
      width:var(--btn-size);height:var(--btn-size);border-radius:50%;background:rgba(0,0,0,0.66);display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:20px;border:2px solid rgba(255,255,255,0.12);cursor:pointer;touch-action:manipulation}
    .vid-meta{flex:1;color:#fff;font-size:13px}
    .controls-row{display:flex;justify-content:space-between;align-items:center}
    .btn{background:rgba(255,255,255,0.08);color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:13px;touch-action:manipulation}

    /* Left controls */
    .leftControls { position: fixed; left: 12px; top: 12px; z-index:9999; display:flex; gap:8px; flex-direction:column; }
    .leftControls .smallBtn { background:rgba(0,0,0,0.6); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px }

    /* helper note */
    #note{position:fixed;left:12px;bottom:12px;z-index:9999;color:rgba(255,255,255,0.85);background:rgba(0,0,0,0.4);padding:8px 10px;border-radius:8px;font-size:12px}

    /* Simulated BG fullscreen classes */
    .bg-sim-fullscreen a-scene{ position: fixed; inset: 0; z-index:1; }
    .simfs-indicator{position:fixed;left:12px;top:140px;z-index:9999;background:rgba(0,0,0,0.6);color:#fff;padding:6px 10px;border-radius:6px;font-size:13px;display:none}

    /* ---------- MOBILE: optimize for 16:9 (landscape) and small widths ---------- */
    /* Use media query: if device is narrow (mobile) OR has approx 16:9 */
    @media (max-width:900px), (max-aspect-ratio:16/9) {
      :root{ --sidebar-w: calc(100% - 24px); --thumb-w: 160px; --thumb-h: 90px; --btn-size:52px }
      /* Move sidebar to bottom with horizontal scroll (landscape phones) */
      #sidebar{
        right:12px; left:12px; top:auto; bottom:12px;
        width:calc(100% - 24px);
        height:120px;
        max-height:120px;
        display:flex; gap:8px; overflow-x:auto; overflow-y:hidden; align-items:center; padding:10px;
        border-radius:12px;
        -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
      }
      .vid-item{ min-width:170px; flex-direction:column; justify-content:flex-start; align-items:flex-start; background:rgba(255,255,255,0.02); padding:6px}
      .vid-thumb{ width:160px; height:90px; border-radius:8px }
      .vid-meta { width:100%; padding-top:6px }
      .controls-row{ width:100% }
      .centerBtn{ width:52px;height:52px; font-size:22px; border-radius:26px }
      /* Make A-Frame canvas full bleed under safe-area */
      a-scene { position:fixed; inset:0; z-index:1; }
      /* Simfs note visible on mobile when active */
      .bg-sim-fullscreen .simfs-indicator { display:block; }
    }

    /* Very small screens (portrait phones) — keep sidebar vertical but narrower */
    @media (max-width:420px) and (orientation:portrait) {
      :root{ --sidebar-w:220px; --thumb-w:88px; --thumb-h:50px; --btn-size:44px }
      #sidebar{ width:var(--sidebar-w); top:10px; right:8px; }
      .vid-thumb{ width:var(--thumb-w); height:var(--thumb-h) }
    }

    /* Accessibility / reduce motion: if prefers-reduced-motion, reduce gyro smoothing / transitions */
    @media (prefers-reduced-motion: reduce) {
      #sidebar, .vid-item { transition: none }
    }
  </style>
</head>
<body>

  <!-- Left controls -->
  <div class="leftControls" aria-hidden="false">
    <button id="toggleSidebar" class="smallBtn" aria-pressed="false">Hide Videos</button>
    <button id="globalMuteBtn" class="smallBtn" aria-pressed="true">Unmute All</button>
    <button id="bgToggle" class="smallBtn">Maximize Background</button>
    <button id="enableGyroBtn" class="smallBtn" aria-pressed="false">Enable Gyro</button>
  </div>
  <div id="simFsNote" class="simfs-indicator">Background: simulated fullscreen (sidebar still visible)</div>

  <!-- Sidebar (right on desktop, bottom on mobile landscape) -->
  <div id="sidebar" role="region" aria-label="Memory videos">
    <!-- Template repeated 5 times -->
    <div class="vid-item" data-index="1">
      <div class="vid-thumb" aria-hidden="true">
        <video id="sideVid1" preload="metadata" playsinline webkit-playsinline muted controlslist="nofullscreen nodownload"></video>
        <button class="centerBtn" data-index="1" aria-label="Play memory 1">▶</button>
      </div>
      <div class="vid-meta">
        <div class="title">Memory 1 — Wedding</div>
        <div class="controls-row"><div id="dur1" style="font-size:12px;opacity:0.8">00:00</div>
          <div><button class="btn fsBtn" data-index="1">Fullscreen</button></div></div>
      </div>
    </div>

    <div class="vid-item" data-index="2">
      <div class="vid-thumb" aria-hidden="true">
        <video id="sideVid2" preload="metadata" playsinline webkit-playsinline muted controlslist="nofullscreen nodownload"></video>
        <button class="centerBtn" data-index="2" aria-label="Play memory 2">▶</button>
      </div>
      <div class="vid-meta">
        <div class="title">Memory 2 — Family Trip</div>
        <div class="controls-row"><div id="dur2" style="font-size:12px;opacity:0.8">00:00</div>
          <div><button class="btn fsBtn" data-index="2">Fullscreen</button></div></div>
      </div>
    </div>

    <div class="vid-item" data-index="3">
      <div class="vid-thumb" aria-hidden="true">
        <video id="sideVid3" preload="metadata" playsinline webkit-playsinline muted controlslist="nofullscreen nodownload"></video>
        <button class="centerBtn" data-index="3" aria-label="Play memory 3">▶</button>
      </div>
      <div class="vid-meta">
        <div class="title">Memory 3 — Childhood Home</div>
        <div class="controls-row"><div id="dur3" style="font-size:12px;opacity:0.8">00:00</div>
          <div><button class="btn fsBtn" data-index="3">Fullscreen</button></div></div>
      </div>
    </div>

    <div class="vid-item" data-index="4">
      <div class="vid-thumb" aria-hidden="true">
        <video id="sideVid4" preload="metadata" playsinline webkit-playsinline muted controlslist="nofullscreen nodownload"></video>
        <button class="centerBtn" data-index="4" aria-label="Play memory 4">▶</button>
      </div>
      <div class="vid-meta">
        <div class="title">Memory 4 — Festival</div>
        <div class="controls-row"><div id="dur4" style="font-size:12px;opacity:0.8">00:00</div>
          <div><button class="btn fsBtn" data-index="4">Fullscreen</button></div></div>
      </div>
    </div>

    <div class="vid-item" data-index="5">
      <div class="vid-thumb" aria-hidden="true">
        <video id="sideVid5" preload="metadata" playsinline webkit-playsinline muted controlslist="nofullscreen nodownload"></video>
        <button class="centerBtn" data-index="5" aria-label="Play memory 5">▶</button>
      </div>
      <div class="vid-meta">
        <div class="title">Memory 5 — Garden</div>
        <div class="controls-row"><div id="dur5" style="font-size:12px;opacity:0.8">00:00</div>
          <div><button class="btn fsBtn" data-index="5">Fullscreen</button></div></div>
      </div>
    </div>
  </div>

  <div id="note">Tip: tap center button to play & go fullscreen. Use "Maximize Background" to enlarge 360° while keeping controls.</div>

  <!-- A-Frame scene for 360 background -->
  <a-scene embedded style="position:fixed;inset:0;z-index:1">
    <a-assets>
      <video id="bgLow" playsinline loop muted crossorigin="anonymous"></video>
      <video id="bgHigh" playsinline loop muted crossorigin="anonymous"></video>
      <video id="bgAsset" src="#bgLow"></video>
    </a-assets>

    <a-sky id="sky" src="#bgAsset" rotation="0 -90 0"></a-sky>
    <a-entity id="afCamera" camera look-controls position="0 1.6 0"></a-entity>
  </a-scene>

<script>
/* ========= ASSET PATHS (EDIT THESE ONLY) ========= */
const ASSETS = {
  bgLow:  'assets/bg_low.mp4',   // mobile-friendly low-res 360 (recommended H.264 ~1-2Mbps)
  bgHigh: 'assets/6060.mp4',     // full-res 360 (desktop)
  small1: 'assets/6061.mp4',
  small2: 'assets/6062.mp4',
  small3: 'assets/6063.mp4',
  small4: 'assets/6064.mp4',
  small5: 'assets/6065.mp4'
};
/* ================================================ */

/* DOM refs */
const bgLow = document.getElementById('bgLow');
const bgHigh = document.getElementById('bgHigh');
const bgAsset = document.getElementById('bgAsset');
const afCameraEl = document.getElementById('afCamera');

const sideVids = [
  document.getElementById('sideVid1'),
  document.getElementById('sideVid2'),
  document.getElementById('sideVid3'),
  document.getElementById('sideVid4'),
  document.getElementById('sideVid5')
];
const centerBtns = Array.from(document.getElementsByClassName('centerBtn'));
const fsBtns = Array.from(document.getElementsByClassName('fsBtn'));
const toggleSidebarBtn = document.getElementById('toggleSidebar');
const sidebar = document.getElementById('sidebar');
const bgToggle = document.getElementById('bgToggle');
const simFsNote = document.getElementById('simFsNote');
const globalMuteBtn = document.getElementById('globalMuteBtn');
const enableGyroBtn = document.getElementById('enableGyroBtn');

let singlePlay = true;
let globalMuted = true;
let simFs = false;
let gyroOn = false;

/* Assign small video sources (preload metadata only) */
sideVids[0].src = ASSETS.small1;
sideVids[1].src = ASSETS.small2;
sideVids[2].src = ASSETS.small3;
sideVids[3].src = ASSETS.small4;
sideVids[4].src = ASSETS.small5;

/* Choose background: pick low-res on small screens for perf */
bgLow.src = ASSETS.bgLow;
bgHigh.src = ASSETS.bgHigh;
function useAppropriateBg() {
  // Use bgLow for narrow / mobile screens (saves CPU/BW). Use bgHigh for large screens.
  const w = window.innerWidth, h = window.innerHeight;
  const aspect = w / h;
  const mobileThreshold = 900; // px
  if (w <= mobileThreshold || aspect <= (16/9)) {
    bgAsset.setAttribute('src', '#bgLow');
    try { bgLow.play().catch(()=>{}); } catch(e){}
  } else {
    bgAsset.setAttribute('src', '#bgHigh');
    try { bgHigh.play().catch(()=>{}); } catch(e){}
  }
}
useAppropriateBg();
window.addEventListener('resize', () => { useAppropriateBg(); });

/* start background (muted) */
try { bgLow.muted = true; bgLow.loop = true; bgLow.play().catch(()=>{}); } catch(e){}
try { bgHigh.muted = true; bgHigh.loop = true; bgHigh.play().catch(()=>{}); } catch(e){}

/* initialize mute state for side videos */
function applyGlobalMute() {
  sideVids.forEach(v => { try { v.muted = globalMuted; v.preload = 'metadata'; } catch(e){} });
  globalMuteBtn.textContent = globalMuted ? 'Unmute All' : 'Mute All';
}
applyGlobalMute();

/* Helper: format time */
function formatTime(s){ if(isNaN(s)) return '00:00'; const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=Math.floor(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }

/* Show durations */
sideVids.forEach((v,i)=>{
  const durEl = document.getElementById('dur'+(i+1));
  v.addEventListener('loadedmetadata', ()=> durEl.textContent = formatTime(v.duration));
  v.addEventListener('timeupdate', ()=> durEl.textContent = formatTime(v.currentTime));
  v.addEventListener('ended', ()=> {
    const btn = centerBtns.find(b=>b.dataset.index == (i+1));
    if(btn) btn.textContent = '▶';
  });
});

/* Pause others when single playing */
function pauseOtherSideVideos(exceptIndex) {
  sideVids.forEach((other, j) => {
    if (j !== exceptIndex && !other.paused) {
      other.pause();
      const cb = centerBtns.find(b => b.dataset.index == (j+1));
      if (cb) cb.textContent = '▶';
    }
  });
}

/* Play + fullscreen logic (center button) */
centerBtns.forEach(btn=>{
  btn.addEventListener('click', async (e)=>{
    e.stopPropagation();
    const idx = Number(btn.dataset.index)-1;
    const v = sideVids[idx];
    if(!v) return;

    if (v.paused) {
      if (singlePlay) pauseOtherSideVideos(idx);
      v.muted = globalMuted;
      try {
        await v.play();
        btn.textContent = '❚❚';
      } catch(err) {
        console.warn('Play blocked', err);
        alert('Playback blocked — tap the screen then try again.');
        return;
      }
      // auto-unmute in fullscreen
      if (globalMuted) v.muted = false;
      // Request native fullscreen for the video
      try {
        if (v.requestFullscreen) await v.requestFullscreen();
        else if (v.webkitRequestFullscreen) await v.webkitRequestFullscreen();
        else if (v.mozRequestFullScreen) await v.mozRequestFullScreen();
        else if (v.msRequestFullscreen) await v.msRequestFullscreen();
      } catch(fsErr){
        console.warn('Fullscreen failed', fsErr);
      }
    } else {
      v.pause();
      btn.textContent = '▶';
      // Restore mute if needed after exiting fullscreen handled in fullscreenchange
    }
  });
});

/* Fullscreen buttons */
fsBtns.forEach(b=>{
  b.addEventListener('click', async (e)=>{
    e.stopPropagation();
    const idx = Number(b.dataset.index)-1;
    const v = sideVids[idx];
    if(!v) return;
    if (singlePlay) pauseOtherSideVideos(idx);
    try { await v.play(); } catch(e){ console.warn('play blocked', e); }
    if (globalMuted) v.muted = false;
    try {
      if (v.requestFullscreen) await v.requestFullscreen();
      else if (v.webkitRequestFullscreen) await v.webkitRequestFullscreen();
      else if (v.mozRequestFullScreen) await v.mozRequestFullScreen();
      else if (v.msRequestFullscreen) await v.msRequestFullscreen();
    } catch(err) { console.warn('fs fail', err); }
    const cb = centerBtns.find(x=>x.dataset.index==(idx+1)); if(cb) cb.textContent='❚❚';
  });
});

/* Global mute toggle */
globalMuteBtn.addEventListener('click', ()=> {
  globalMuted = !globalMuted;
  applyGlobalMute();
});

/* fullscreenchange: re-apply mute settings after exit */
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    sideVids.forEach(v => { try{ v.muted = globalMuted; } catch(e){} });
    // re-enable gyro after native fullscreen exit
    if (!gyroOn) { /* no-op */ } // keep previous state
  } else {
    // When entering fullscreen on a side video, disable gyro to avoid conflicts
    const fsEl = document.fullscreenElement;
    sideVids.forEach(v => {
      if (fsEl === v) {
        try { v.muted = false; } catch(e){}
        // disable gyro temporarily while native fullscreen video plays
        if (gyroOn) { disableGyroTemporarily = true; disableGyro(); }
      }
    });
  }
});

/* Sidebar toggle */
toggleSidebarBtn.addEventListener('click', ()=>{
  const hidden = sidebar.style.display === 'none';
  sidebar.style.display = hidden ? 'flex' : 'none';
  toggleSidebarBtn.textContent = hidden ? 'Hide Videos' : 'Show Videos';
  if(!hidden){ // hide -> pause all
    sideVids.forEach((v,i)=>{ v.pause(); const btn = centerBtns.find(b=>b.dataset.index==(i+1)); if(btn) btn.textContent='▶'; });
  }
});

/* Simulated BG fullscreen */
bgToggle.addEventListener('click', ()=>{
  simFs = !simFs;
  if (simFs) {
    document.documentElement.classList.add('bg-sim-fullscreen');
    simFsNote.style.display = 'block';
    bgToggle.textContent = 'Exit Background Max';
  } else {
    document.documentElement.classList.remove('bg-sim-fullscreen');
    simFsNote.style.display = 'none';
    bgToggle.textContent = 'Maximize Background';
  }
});

/* Pause side vids when page hidden */
document.addEventListener('visibilitychange', ()=> {
  if (document.hidden) {
    sideVids.forEach((v,i)=> { if (!v.paused) { v.pause(); const btn = centerBtns.find(b=>b.dataset.index==(i+1)); if(btn) btn.textContent='▶'; } });
  }
});

/* ----------------- GYRO integration (smoother & mobile-aware) ----------------- */
let disableGyroTemporarily = false;
(function setupGyro() {
  if (!afCameraEl) return;
  const smoothing = 0.14;
  let referenceAlpha = null;
  let gyroActive = false;
  let targetEuler = new THREE.Euler(0,0,0,'YXZ');
  let appliedEuler = new THREE.Euler(0,0,0,'YXZ');

  function handleDO(e) {
    if (!gyroActive) return;
    const alpha = (e.alpha === null) ? 0 : e.alpha;
    const beta  = (e.beta  === null) ? 0 : e.beta;
    const gamma = (e.gamma === null) ? 0 : e.gamma;
    if (referenceAlpha === null) referenceAlpha = alpha;
    const relAlpha = alpha - referenceAlpha;
    // map to three.js Euler (tweak signs if motion feels inverted)
    const yaw   = THREE.MathUtils.degToRad(-relAlpha);
    const pitch = THREE.MathUtils.degToRad(beta);
    const roll  = THREE.MathUtils.degToRad(gamma);
    targetEuler.set(pitch * 0.85, yaw * 0.85, roll * 0.85, 'YXZ');
  }

  function rafUpdate() {
    if (!gyroActive) return;
    appliedEuler.x += (targetEuler.x - appliedEuler.x) * smoothing;
    appliedEuler.y += (targetEuler.y - appliedEuler.y) * smoothing;
    appliedEuler.z += (targetEuler.z - appliedEuler.z) * smoothing;
    try {
      afCameraEl.object3D.rotation.x = appliedEuler.x;
      afCameraEl.object3D.rotation.y = appliedEuler.y;
      afCameraEl.object3D.rotation.z = appliedEuler.z;
    } catch(e){}
    requestAnimationFrame(rafUpdate);
  }

  async function enableGyro() {
    if (gyroActive) return;
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      try {
        const resp = await DeviceOrientationEvent.requestPermission();
        if (resp !== 'granted') { alert('Gyro permission denied'); return; }
      } catch(err) { alert('Gyro permission request failed'); return; }
    }
    window.addEventListener('deviceorientation', handleDO, true);
    referenceAlpha = null;
    gyroActive = true;
    rafUpdate();
    enableGyroBtn.textContent = 'Disable Gyro';
  }

  function disableGyro() {
    if (!gyroActive) return;
    window.removeEventListener('deviceorientation', handleDO, true);
    gyroActive = false;
    enableGyroBtn.textContent = 'Enable Gyro';
  }

  // Attach handlers to global scope for other code to call
  window.enableGyro = enableGyro;
  window.disableGyro = disableGyro;

  enableGyroBtn.addEventListener('click', async () => {
    if (!gyroActive) {
      if (disableGyroTemporarily) { disableGyroTemporarily = false; }
      await enableGyro();
    } else disableGyro();
  });
})();

/* End of script */
console.log('Mobile-optimized page loaded. ASSETS:', ASSETS);

/* Helpful recommendation printed to console */
console.log('Tip: transcode your 5 small videos to mobile-friendly H.264 baseline ~1-2Mbps to reduce stalls on phones.');
</script>
</body>
</html>


